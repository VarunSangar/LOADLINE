<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LOADLINE — Cognitive Load Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0e0f12;
      color: #eaeaf0;
      margin: 0;
      padding: 1rem;
    }

    .container {
      max-width: 900px;
      margin: auto;
    }

    .card {
      background: #161820;
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1.25rem;
    }

    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 0.6rem;
      border-radius: 6px;
      border: none;
      background: #222431;
      color: #fff;
      margin-top: 0.25rem;
    }

    button {
      margin-top: 0.75rem;
      padding: 0.6rem 1rem;
      background: #5b7cff;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }

    button.secondary { background: #2a2d3e; }

    .task {
      border-top: 1px solid #2a2d3e;
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .task.active {
      border-left: 4px solid #5b7cff;
      padding-left: 0.75rem;
    }

    .result {
      font-size: 2.5rem;
      font-weight: bold;
    }

    canvas {
      max-width: 100%;
      margin-top: 1rem;
    }

    .metric {
      margin-top: 0.5rem;
      color: #b3b3c6;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>LOADLINE</h1>
  <p>Cognitive Load Index (CLI)</p>

  <div class="card">
    <h2>Tasks</h2>
    <div id="tasks"></div>
    <button onclick="addTask()">+ Add Task</button>
    <button class="secondary" onclick="addBreak()">+ Add Break</button>
  </div>

  <div class="card">
    <h2>Current CLI</h2>
    <div class="result" id="cliValue">—</div>
    <div class="metric">Peak CLI: <span id="cliPeak">—</span></div>
    <div class="metric">CLI / min: <span id="cliSlope">—</span></div>
    <canvas id="cliChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let tasks = [];
  let activeTaskId = null;
  let cliHistory = [];
  let startTime = Date.now();
  let cliPeak = 0;
  let chart;

  function addTask() {
    createTask("task");
  }

  function addBreak() {
    createTask("break");
  }

  function createTask(type) {
    tasks.push({
      id: Date.now(),
      type,
      name: type === "break" ? "Break" : "",
      complexity: type === "break" ? 0 : 0.5,
      seconds: 0,
      interval: null
    });
    renderTasks();
  }

  function renderTasks() {
    const container = document.getElementById("tasks");
    container.innerHTML = "";

    tasks.forEach(task => {
      const div = document.createElement("div");
      div.className = "task" + (task.id === activeTaskId ? " active" : "");

      div.innerHTML = `
        <label>${task.type === "break" ? "Break" : "Task Name"}</label>
        ${task.type === "break" ? "" : `
          <input type="text" value="${task.name}" oninput="task.name=this.value">
          <label>Complexity (0–1)</label>
          <input type="number" min="0" max="1" step="0.1"
            value="${task.complexity}"
            onchange="task.complexity=Number(this.value)">
        `}
        <div>Time: ${Math.floor(task.seconds/60)}:${String(task.seconds%60).padStart(2,"0")}</div>
        <button onclick="startTask(${task.id})">Start</button>
        <button class="secondary" onclick="stopTask(${task.id})">Stop</button>
      `;
      container.appendChild(div);
    });
  }

  function startTask(id) {
    stopAllTasks();
    const task = tasks.find(t => t.id === id);
    activeTaskId = id;

    task.interval = setInterval(() => {
      task.seconds++;
      calculateCLI();
      renderTasks();
    }, 1000);
  }

  function stopTask(id) {
    const task = tasks.find(t => t.id === id);
    if (task?.interval) clearInterval(task.interval);
    activeTaskId = null;
  }

  function stopAllTasks() {
    tasks.forEach(t => t.interval && clearInterval(t.interval));
  }

  function calculateCLI() {
    let totalLoad = 0;
    let contributions = [];

    tasks.forEach(t => {
      if (t.type === "break") return;

      const timeFactor = Math.min(t.seconds / 3600, 1);
      const load = (t.complexity + timeFactor) / 2;
      contributions.push({ name: t.name || "Unnamed", load });
      totalLoad += load;
    });

    // Break decay
    const active = tasks.find(t => t.id === activeTaskId);
    if (active?.type === "break") {
      totalLoad *= 0.985; // decay rate
    }

    const CLI = Math.min(100, totalLoad * 60);
    cliPeak = Math.max(cliPeak, CLI);

    cliHistory.push({ time: (Date.now()-startTime)/60000, CLI });

    updateDisplay(CLI, contributions);
  }

  function updateDisplay(CLI, contributions) {
    document.getElementById("cliValue").innerText = Math.round(CLI);
    document.getElementById("cliPeak").innerText = Math.round(cliPeak);

    if (cliHistory.length > 1) {
      const dt = cliHistory.at(-1).time - cliHistory[0].time;
      const dCLI = cliHistory.at(-1).CLI - cliHistory[0].CLI;
      document.getElementById("cliSlope").innerText =
        (dCLI / dt).toFixed(2);
    }

    renderChart(contributions);
  }

  function renderChart(contributions) {
    const ctx = document.getElementById("cliChart");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: contributions.map(c => c.name),
        datasets: [{
          data: contributions.map(c => c.load),
          backgroundColor: ["#5b7cff","#22c55e","#facc15","#f87171","#38bdf8"]
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: "#eaeaf0" } }
        }
      }
    });
  }
</script>
</body>
</html>
