<script>
/* ========= ACCESS ========= */
const VALID_CODES = ["turtle123"];
function unlock(){
  if(VALID_CODES.includes(accessCode.value)){
    gate.style.display="none";
    app.style.display="block";
    sessionStart = Date.now();
    setInterval(tick,1000);
    initChart();
  } else error.textContent="Invalid access code.";
}

/* ========= STATE ========= */
let tasks=[];
let activeTask=null;
let sessionStart=null;
let cliPeak=0;
let cliLog=[];
let chart=null;

/* ========= TASK HELPERS ========= */
function updateName(id,val){
  const t=tasks.find(x=>x.id===id);
  if(t) t.name=val;
}
function updateDifficulty(id,val){
  const t=tasks.find(x=>x.id===id);
  if(t) t.difficulty=Number(val);
}

/* ========= TASKS ========= */
function addTask(){ createTask("task"); }
function addBreak(){ createTask("break"); }

function createTask(type){
  tasks.push({
    id:Date.now()+Math.random(),
    type,
    name:type==="break"?"Break":"",
    difficulty:type==="break"?0:0.5,
    seconds:0,
    cliContribution:0
  });
  renderTasks();
}

function renderTasks(){
  const el=document.getElementById("tasks");
  el.innerHTML="";
  tasks.forEach(t=>{
    const div=document.createElement("div");
    div.className="task"+(activeTask===t.id?" active":"");
    div.innerHTML=`
      ${t.type==="task"?`
        <label>Task Name</label>
        <input value="${t.name}"
          oninput="updateName(${t.id},this.value)">
        <label>Difficulty (0–1)</label>
        <input type="number" min="0" max="1" step="0.1"
          value="${t.difficulty}"
          onchange="updateDifficulty(${t.id},this.value)">
      `:`<strong>Break</strong>`}
      <div class="metric">⏱ ${Math.floor(t.seconds/60)}:${String(t.seconds%60).padStart(2,"0")}</div>
      <button onclick="start(${t.id})">Start</button>
      <button class="secondary" onclick="stop()">Stop</button>
    `;
    el.appendChild(div);
  });
}

function start(id){ activeTask=id; }
function stop(){ activeTask=null; }

/* ========= CORE LOOP ========= */
function tick(){
  const elapsed=Math.floor((Date.now()-sessionStart)/1000);
  sessionTime.textContent=
    `${Math.floor(elapsed/60)}:${String(elapsed%60).padStart(2,"0")}`;

  if(activeTask){
    const t=tasks.find(x=>x.id===activeTask);
    if(t) t.seconds++;
  }

  renderTasks();
  computeCLI();
}

/* ========= CLI MODEL ========= */
function computeCLI(){
  let totalLoad=0;
  let contributors=[];

  tasks.forEach(t=>{
    let load=0;

    if(t.type==="task"){
      const timeFactor=Math.min(t.seconds/1800,1);
      load=(t.difficulty+timeFactor)/2;
    }

    if(t.type==="break" && activeTask===t.id){
      load=-0.015 * t.seconds;
    }

    t.cliContribution=load;
    if(load>0 && t.type==="task"){
      contributors.push({ name:t.name||"Task", load });
    }

    totalLoad+=load;
  });

  const CLI=Math.max(0,Math.min(100,totalLoad*30));
  cliPeak=Math.max(cliPeak,CLI);
  cliLog.push({time:Date.now(),cli:CLI});

  cliValue.textContent=Math.round(CLI);
  cliPeak.textContent=Math.round(cliPeak);

  if(cliLog.length>10){
    const a=cliLog.at(-1);
    const b=cliLog.at(-10);
    cliRate.textContent=
      ((a.cli-b.cli)/((a.time-b.time)/60000)).toFixed(2);
  }

  updateChart(contributors);
}

/* ========= PIE ========= */
function initChart(){
  chart=new Chart(pieChart,{
    type:"pie",
    data:{ labels:["Idle"], datasets:[{data:[1],backgroundColor:["#2a2d3e"]}] },
    options:{
      animation:false,
      plugins:{legend:{position:"bottom",labels:{color:"#eaeaf0"}}}
    }
  });
}

function updateChart(contributors){
  if(!contributors.length){
    chart.data.labels=["Idle"];
    chart.data.datasets[0].data=[1];
    chart.update(); return;
  }

  const total=contributors.reduce((s,c)=>s+c.load,0);
  chart.data.labels=contributors.map(c=>c.name);
  chart.data.datasets[0].data=
    contributors.length===1?[1]:contributors.map(c=>c.load/total);
  chart.data.datasets[0].backgroundColor=[
    "#5b7cff","#22c55e","#f97316","#ec4899","#a855f7"
  ];
  chart.update();
}

/* ========= EXPORT ========= */
function exportCSV(){
  let csv="time,task,type,difficulty,seconds,cli\n";
  tasks.forEach(t=>{
    csv+=`${Date.now()},${t.name},${t.type},${t.difficulty},${t.seconds},${t.cliContribution}\n`;
  });
  download(csv,"loadline.csv","text/csv");
}

function exportJSON(){
  download(JSON.stringify({tasks,cliLog},null,2),
           "loadline.json","application/json");
}

function download(data,name,type){
  const blob=new Blob([data],{type});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>
